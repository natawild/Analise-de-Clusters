---
title: "Diabetes"
author: "Grupo 4"
date: "03/12/2019"
output: html_document
---

# Apresentação do caso de estudo 

Este data set foi extraido no Kaggle, mas originalmente foi retirado do Instituto Nacional de Diabetes e Doenças Digestivas e Renais dos Estados Unidos. O objetivo deste conjunto de dados seria prever se um paciente tem ou não diabetes, baseado em determinadas medidas de diagnóstico incluídas no data set. Neste conjunto de dados estão presentes pacientes do género feminino com pelo menos 21 anos de idade e origem da povoação indigena Pima. 


## O que é diabetes 
A diabetes é uma doença metabólica crónica que se caracteriza por estados de hiperglicemia (níveis elevados de açúcar no sangue) constantes, os quais resultam de uma deficiência na produção/ secreção de insulina (hormona que atua na regulação da glicemia), de uma alteração na sua ação ou de ambas, resultando num metabolismo anormal dos macronutrientes ingeridos através da alimentação. 

De um modo geral, a doença pode ser classificada em 3 categorias: 

* Diabetes tipo 1: é uma doença autoimune, na qual o próprio sistema imune destrói as células pancreáticas produtoras de insulina. Por esse motivo, é também chamada de insulino-dependente, uma vez que a sobrevivência da pessoa depende da administração de insulina exógena; 

* Diabetes tipo 2: devida à perda de função progressiva das células pancreáticas produtoras de insulina, resultando numa expressão menor de insulina. Está intimamente relacionada com a obesidade ou excesso de peso, maus hábitos alimentares e elevados níveis de sedentarismo; 

* Diabetes gestacional: quando a anormalidade na glicemia é diagnosticada no 2º ou 3º trimestre da gravidez, sem diabetes prévia à gestação; 

Existem ainda outros tipos específicos, associados a doenças que afetam a porção exócrina do pâncreas como fibrose cística, pancreatite ou induzidos por medicamentos como corticoides, imunossupressores ou anti-retrovirais, mas estes não são tão comuns.  

Os valores de referência da diabetes ajudam a estabelecer condições de normoglicemia, hiperglicemia ou hipoglicemia e a fazer o diagnóstico da doença.  

* NORMOGLICEMIA- É o mesmo que dizer que os valores da glicose estão dentro da normalidade. Para que os valores sejam considerados normais, a glicose deve estar os 80 mg/dl e os 140 mg/dl, dependendo se a análise foi feita em jejum ou após a refeição. 

* HIPERGLICEMIA - Acontece quando os valores da glicose ultrapassam os valores normais, ou seja, os níveis de açúcar no sangue são altos. Isto acontece por três razões: o organismo produz insulina a menos, o organismo não utiliza bem a insulina ou uma combinação das duas.  

* HIPOGLICEMIA - Por outro lado, quando os valores de açúcar estão baixos demais, os doentes podem ter sintomas como tremores, suores, fraqueza, batimentos cardíacos rápidos ou fortes, tonturas, visão dupla ou desmaios. Se não for detetada e tratada pode ter ainda consequências mais graves como lesões cerebrais ou morte. Se ingerir algo doce, como um sumo de fruta, os valores devem voltar à normalidade. 


A tabela abaixo explica os valores de glicose 2 horas após a refeição  

| VALORES DE REFERÊNCIA 2 HORAS APÓS A REFEIÇÃO |              |
|-----------------------------------------------|--------------|
| inferior 70 mg/dl                             | hipoglicemia |
| 70 mg/dl a 140 mg/dl                          | normal       |
| 140 mg/dl a 199 mg/dl                         | pré-diabetes |
| superior 200 mg/dl                            | diabetes     |
 


## Descrição dos dados 
O dataset contém informações de 768 mulheres, das quais 268 mulheres foram diagnosticadas com diabetes. As informações disponíveis incluem 8 variáveis, tais como Idade, Número de gestações, Glicose, Insulina, etc. Uma descrição mais detalhada sobre as variáveis está exposta nos pontos abaixo. A variável de resposta no conjunto de dados é um classificador binário, *Outcome*, que indica se a pessoa foi diagnosticada com diabetes ou não. 



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
library(readr)
diabetes <- read_csv("diabetes.csv")
attach(diabetes)

```



```{r criacao}

Outcome <- factor(diabetes$Outcome)
levels(Outcome) <- c("Não", "Sim")
is.factor(Outcome)
summary(Outcome)
```

# Tratamento do dados 
| Result      | Oral Glucose Tolerance Test (OGTT) |
|-------------|------------------------------------|
| Normal      | less than 140 mg/dl                |
| Prediabetes | 140 mg/dl to 199 mg/dl             |
| Diabetes    | 200 mg/dl or higher                |


```{r tratamento dos dados}
#library(Amelia)

sapply(diabetes, function (x) sum(is.na(x)))

#saber se existem missing values
#data<- subset(diabetes,select=c(1,2,3,4,5,6,7,8,9))
#missmap(data, main = "Missing values vs observed")

library(lattice)


missing_data <- diabetes[,setdiff(names(diabetes), c('Outcome', 'Pregnancies'))]
features_miss_num <- apply(missing_data, 2, function(x) sum(x <= 0))
features_miss <- names(missing_data)[ features_miss_num > 0]


rows_miss <- apply(missing_data, 1, function(x) sum(x <= 0) >= 1) 
sum(rows_miss)

missing_data[missing_data <= 0] <- NA
diabetes[, names(missing_data)] <- missing_data



# KNN imputation
orig_data <- diabetes
colSums(is.na(diabetes))

diabetes[,c(-8)] 
diabetes <- diabetes[,c(-8)]


diabetes$Glucose[is.na(diabetes$Glucose)] <- mean(diabetes$Glucose,na.rm=T)
diabetes$Insulin[is.na(diabetes$Insulin)] <- mean(diabetes$Insulin,na.rm=T)
diabetes$SkinThickness[is.na(diabetes$SkinThickness)] <- mean(diabetes$SkinThickness,na.rm=T)
diabetes$BMI[is.na(diabetes$BMI)] <- mean(diabetes$BMI,na.rm=T)
diabetes$BloodPressure[is.na(diabetes$BloodPressure)] <- mean(diabetes$BloodPressure,na.rm=T)



#diabetes=data.frame(Pregnancies,Glucose,BloodPressure,SkinThickness,Insulin,BMI,DiabetesPedigreeFunction,Age, Outcome)
#attach(diabetes)

```


```{r seedtt}
library(caret)
library(ggplot2)

# Prep Training e Test
set.seed(100)
trainDataIndex <- createDataPartition(Outcome, p=0.7, list = F) # 70% training data
train <- diabetes[trainDataIndex, ]
test <- diabetes[-trainDataIndex, ]



#Modelo

model <- glm(Outcome ~.,family=binomial(link='logit'),data=train)
summary(model)





```





```{r model}
library(tidyverse)
library(caret)
library(leaps)
library(tidyr)
library(dplyr)
library(MASS)

#ajuste completo do modelo 
full.model <- glm(Outcome~.,family=binomial(link='logit'),data=train)

summary(full.model)


#método both 
step.model <- stepAIC(full.model, direction = "both",
                      trace = FALSE)
summary(step.model)

#método backward
step.modelb <- stepAIC(full.model, direction = "backward",
                      trace = FALSE)
summary(step.modelb)

#método forward
step.modelf <- stepAIC(full.model, direction = "forward",
                       trace = FALSE)
summary(step.modelf)


#verificar qual o que tem menor AIC
AIC(step.model)
AIC(step.modelb)
AIC(step.modelf)

```

```{r models}
models <- regsubsets(Outcome~., data=train, nvmax = 8, method = "seqrep")
summary(models)


#cross validation
set.seed(123)
# Set up repeated k-fold cross-validation
train.control <- trainControl(method = "cv", number = 10)
# Train the model
step.model <- train(Outcome~., data = diabetes,
                    method = "leapBackward",
                    tuneGrid = data.frame(nvmax = 1:8),
                    trControl = train.control)

# precisão do modelo - escolher o menor erro médio de previsão e MAE, R squared quanto maior melhor 
step.model$results


#melhor modelo 
step.model$bestTune

#coeficientes finais do modelo 
coef(step.model$finalModel, 4)
summary(step.model$finalModel)
```


```{r model2}

model2= glm(Outcome~ Pregnancies + Glucose + BMI + DiabetesPedigreeFunction,family=binomial(link='logit'),data=train)
summary(model2)

```

```{r p}
library(yhat)
yhat=fitted.values(model2)

fitted.results <- predict(model2,newdata=subset(test,select=c(1,2,3,6,7)),type='response')
fitted.results <- ifelse(fitted.results > 0.5,1,0)
misClasificError <- mean(fitted.results != test$Outcome)
print(paste('Accuracy',1-misClasificError))

library(tidyverse) # for data manipulation
library(dlstats)    # for package download stats
library(pkgsearch)
library(ROCR)
library(gplots)


p <- predict(model2, newdata=subset(test,select=c(1,2,3,6,7)), type="response")
pr <- prediction(p, test$Outcome)
prf <- performance(pr, measure = "tpr", x.measure = "fpr")
plot(prf)


```


```{r auc}
auc <- performance(pr, measure = "auc")
auc <- auc@y.values[[1]]
auc

```
```{r pri}
library(yhat)
pr_i <- prediction(yhat, train$Outcome)
prf_i <- performance(pr_i, measure = "tpr", x.measure = "fpr")
plot(prf_i)
```


```{r auci}
auc_i <- performance(pr_i, measure = "auc")
auc_i <- auc_i@y.values[[1]]
auc_i

```

